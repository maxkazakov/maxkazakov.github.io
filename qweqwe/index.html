<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>История факапа #1</title>

	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link rel="stylesheet" type="text/css" href="../assets/css/style.css?v=172587de66" />

	<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" />
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="Max Kazakov" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="История факапа #1" />
    <meta property="og:description" content="Планируя работы на февраль 2019 года по основному проекту, на котором работаю, я
подумал, что неплохо было бы зарефакторить код, ответственный за парсинг данных.
Так вышло, что в процессе рефакторинга я, сам того не подозревая, заложил в
кодовую базу бомбу замедленного действия.

Предыстория
2 года назад наша команда внедряла в функционал одного из модулей приложения
технологию Couchbase + Sync Gateway. В двух словах: технология позволяет
синхронизировать БД между приложением и сервером. Внедрял" />
    <meta property="og:url" content="http://localhost:2368/qweqwe/" />
    <meta property="article:published_time" content="2019-05-10T19:40:25.000Z" />
    <meta property="article:modified_time" content="2019-06-04T17:22:44.000Z" />
    <meta property="article:publisher" content="https://www.facebook.com/max.kazakov.376" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="История факапа #1" />
    <meta name="twitter:description" content="Планируя работы на февраль 2019 года по основному проекту, на котором работаю, я
подумал, что неплохо было бы зарефакторить код, ответственный за парсинг данных.
Так вышло, что в процессе рефакторинга я, сам того не подозревая, заложил в
кодовую базу бомбу замедленного действия.

Предыстория
2 года назад наша команда внедряла в функционал одного из модулей приложения
технологию Couchbase + Sync Gateway. В двух словах: технология позволяет
синхронизировать БД между приложением и сервером. Внедрял" />
    <meta name="twitter:url" content="http://localhost:2368/qweqwe/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Max Kazakov" />
    <meta name="twitter:site" content="@maxxkazakov" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Max Kazakov",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/favicon.ico",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Max Kazakov",
        "image": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/content/images/2019/05/Screenshot-2019-05-11-at-10.58.30.png",
            "width": 636,
            "height": 854
        },
        "url": "http://localhost:2368/author/max/",
        "sameAs": []
    },
    "headline": "История факапа #1",
    "url": "http://localhost:2368/qweqwe/",
    "datePublished": "2019-05-10T19:40:25.000Z",
    "dateModified": "2019-06-04T17:22:44.000Z",
    "description": "Планируя работы на февраль 2019 года по основному проекту, на котором работаю, я\nподумал, что неплохо было бы зарефакторить код, ответственный за парсинг данных.\nТак вышло, что в процессе рефакторинга я, сам того не подозревая, заложил в\nкодовую базу бомбу замедленного действия.\n\nПредыстория\n2 года назад наша команда внедряла в функционал одного из модулей приложения\nтехнологию Couchbase + Sync Gateway. В двух словах: технология позволяет\nсинхронизировать БД между приложением и сервером. Внедрял",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <meta name="generator" content="Ghost 2.22" />
    <link rel="alternate" type="application/rss+xml" title="Max Kazakov" href="../rss/index.html" />
    <script>var disqus = 'maxkazakov-iosblog';</script>
</head>

<body class="post-template">

	<nav id="menu">
	<a class="close-button">Close</a>
	<div class="nav-wrapper">
		<p class="nav-label">Menu</p>
		<ul>
			<li class="nav-home" role="presentation"><a href="../index.html">Home</a></li>
			<li class="nav-twitter"><a href="https://twitter.com/maxxkazakov" title="@maxxkazakov"><i class="ic ic-twitter"></i> Twitter</a></li>
			<li class="nav-facebook"><a href="https://www.facebook.com/max.kazakov.376" title="max.kazakov.376"><i class="ic ic-facebook"></i> Facebook</a></li>
			<li class="nav-rss"><a href="../rss/index.html"><i class="ic ic-rss"></i> Subscribe</a></li>
		</ul>
	</div>
</nav>


	<section id="wrapper">
		<a class="hidden-close"></a>
		

<div class="progress-container">
	<span class="progress-bar"></span>
</div>

<header id="post-header" >
	<div class="inner">
		<nav id="navigation">
			<span id="home-button" class="nav-button">
				<a class="home-button" href="../index.html" title="Home"><i class="ic ic-arrow-left"></i>
					Home</a>
			</span>
			<span id="menu-button" class="nav-button">
				<a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
			</span>
		</nav>
		<h1 class="post-title">История факапа #1</h1>
		<span class="post-meta"><a href="../author/max/index.html">Max Kazakov</a> | <time
				datetime="2019-05-11">11 May 2019</time></span>
			</div>
</header>

<main class="content" role="main">
	<article class="post">
		<div class="inner">

			<section class="post-content">
				<p>Планируя работы на февраль 2019 года по основному проекту, на котором работаю, я подумал, что неплохо было бы зарефакторить код, ответственный за парсинг данных. Так вышло, что в процессе рефакторинга я, сам того не подозревая, заложил в кодовую базу бомбу замедленного действия.</p><h2 id="-">Предыстория</h2><p>2 года назад наша команда внедряла в функционал одного из модулей приложения технологию Couchbase + Sync Gateway. В двух словах: технология позволяет синхронизировать БД между приложением и сервером. Внедряли мы ее с целью избавиться от недостатков http протокола. Идея простая — http запросов для нас нет, есть постоянная синхронизация БД на сервере и на клиенте. Любой запрос на клиенте/ответ сервера клиенту реализуется при помощи записи в БД. Обе стороны слушают изменения в своей БД и реагируют на них должным образом. Такая абстракция позволяет не задумываться о том, в каком состоянии находятся http запросы. Просто настраиваем репликатор (сущность, которая синхронизирует БД) и поехали. Есть недостатки вида "как решать конфликты", "как управлять потоком синхронизации" и т.д., но сегодня не об этом.</p><p>Couchbase Lite (библиотека для работы с БД на устройстве) поддерживает работу с Data Access Object (DTO), например, как NSManagedObject в CoreData, или Object в Realm. Но сроки и нежелание чуть больше завязываться на возможности конкретной библиотеки привели нас к быстрому решению использовать Dictionary&lt;String: Any&gt; для мапинга моделей из БД в код и обратно. Поэтому мы написали несколько удобных расширений для этого типа и были довольны. У нас не было уверенности в технологии, мы пробовали, поэтому абстрагирование реализации моделей данных от конкретной реализации БД выглядело логично.</p><h2 id="--1">Работает — не трогай</h2><p>От технологии мы отказались, перешли на новую, самописную (кросплатформенные с++ фреймворки). Переход был быстрым, в том числе благодаря абстрагированию от источника данных. Новая технология не реализует DTO, и отдает нам в качестве моделей голые строки. Т.е. модели в БД представлены строками, а значит, парсим каждый раз при чтении из БД (очевидно, бьет по производительности, но некритично). Это важно отметить, т.к. в дальнейшем это только усилит последствия факапа.</p><p>Парсинг не требовал изменений при переходе, работал отлично. Но было решено переехать на Codable, по ряду причин:</p><!--kg-card-begin: markdown--><ul>
<li>Убрать из процесса парсинга лишнее звено в виде Dictionary</li>
<li>Избавиться от кода в extension Dictionary&lt;String: Any&gt;</li>
<li>Воспользоваться возможностями автогенерации</li>
<li>Сделать парсинг, хорошо понятный любому разработчику</li>
</ul>
<!--kg-card-end: markdown--><h2 id="codable">Codable</h2><p>За пару дней был проведен рефакторинг всех структур данных, их в проекте около 50. Здесь поделюсь парой моментов, которые расстроили и которые редко описываются в туторах по Codable.</p><p>Структуры данных реализованы как классы, а значит, используют наследование. Есть иерархии по 4 наследника. Codable не дает использовать автогенерацию для классов-потомков, чем очень расстроил и вынудил писать (а точнее переписывать) много кода. Причина, по которой так происходит, — компилятор не в силах понять, нужно ли классу потомку <a href="https://docs.swift.org/swift-book/LanguageGuide/Initialization.html#ID222">наследовать</a> родительский конструктор или нужно сгенерировать код для Codable. Об этом хорошие размышления <a href="https://forums.swift.org/t/inheriting-from-a-codable-class/14874/3">здесь</a>.</p><p>Второй небольшой, но неприятный момент — Codable не позволяет игнорировать тип данных. Т.е. если по ключу лежит json-объект, то нельзя просто засунуть его в Data/String в процессе парсинга. Иногда хочется забрать данные, а уже потом поглядеть, что там в них. Или, к примеру, парсить вложенный объект должны не мы, а кто-то другой. В таких ситуациях может выручить библиотека вроде <a href="https://github.com/Flight-School/AnyCodable">этой</a> либо можно попрактиковаться со своей реализацией. Вот также <a href="http://ilya.puchka.me/codable-in-practice/">отличная статья</a>, где автор описывает проблемы с Codable, возникшие при внедрении в проект.</p><h2 id="--2">Факап</h2><p>Пример кода на swift, который все поломал</p><!--kg-card-begin: markdown--><pre><code>enum State: Int, Decodable {
    case unknown = -1
    case new = 0
    case deleted = 1
}

class Model: Decodable {
    let state: State
    
    required init(from decoder: Decoder) throws {
        let container = try decoder.container(keyedBy: CodingKeys.self)
        self.state = (try container.decodeIfPresent(State.self, forKey: .state)) ?? .unknown
    }
    
    enum CodingKeys: CodingKey {
        case state
    }
}
</code></pre>
<!--kg-card-end: markdown--><p>decodeIfPresent может выкинуть единственную ошибку — type mismatch. Приложение упадет, если по ключу лежит тип данных, который мы не ожидаем. В случае с enum типом, неподдерживаемое значение Int в ключе state вызовет падение.</p><p>Так и случилось. На бекенд выкатили обновление с новым кейсом за 5 дней до релиза мобилки, которая этот кейс поддерживает. Старые приложения начали падать. Нужно было срочно решать проблему со стороны бекенда.</p><h2 id="--3">Решение</h2><p>Чтобы правильно понять, где именно нужно фиксить, очень схематично представим, как взаимодействуют сервисы и приложения</p><!--kg-card-begin: image--><figure class="kg-card kg-image-card"><img src="../content/images/2019/06/1-2.png" class="kg-image"></figure><!--kg-card-end: image--><p>В этой схеме наша моделька с неподдерживаемым enum-ом летит из прикладных сервисов (Service 1, 2, 3) в сервис событий (Event Service), сохраняется в БД этого сервиса и дальше летит в приложение и сохраняется в локальную БД.</p><p>Решения пошагово:</p><p>1) Выкатываем на прикладные сервисы хотфикс, который отдает по ключу "state" только те значения, которые поддерживаются текущим приложением. Новый расширенный enum теперь будет передаваться в новом ключе (есть достаточно времени, чтобы поддержать новый ключ в грядущих релизах мобилок).</p><p>2) Проходимся скриптом по БД в сервисе событий и делаем фикс, аналогичный пункту 1.</p><p>Предприняв эти шаги, видим, что в Firebase продолжают падать краши. Есть некоторая часть пользователей, которые успели в локальную БД затянуть невалидные значения. Проблемы можно было избежать, если бы при получении данных из сети мы парсили ее в нормальную структуру БД, а не в строку.</p><p>Теперь нужно как-то почистить локальную БД. Обновление приложения решило бы эту проблему, но до релиза еще пара дней. Переустановить приложения, обзвонив пользователей, — жестко. При логауте чистится локальная БД, значит можно попросить пользователей перелогиниться, но они не могут, т.к. приложение падает сразу же при запуске (падающий модуль запускается первым). Значит, можно разлогинить пользователей удаленно. В крашах Firebase находим id пользователей, которые упали, бекендер пишет скрипт для логаута, запускает его. Проблема решена.</p><h2 id="--4">Вместо вывода</h2><p>Причина ошибки не в том, что я слишком строго парсил данные с сервера, а в том, что элементарно забыл про обратную совместимость. На мой взгляд, кодогенерация для Codable (например Sourcery) не позволила бы избежать проблем в данном случае, т.к. ошибка была сделана именно на уровне логики парсинга. Учитывая тот факт, что число моделей постоянно растет, есть планы прикрутить кодогенерацию, чтобы в том числе исключить человеческий фактор при рефаторинге кода.</p>
			</section>

			<section class="post-info">

				<div class="post-share">
					<a class="twitter" href="https://twitter.com/share?text=История факапа #1&url=http://localhost:2368/qweqwe/"
						onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
						<i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
					</a>
					<a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/qweqwe/"
						onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
						<i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
					</a>
					<div class="clear"></div>
				</div>

				<aside class="post-tags">
					
				</aside>

				<div class="clear"></div>

				<aside class="post-author">
					<figure class="post-author-avatar avatar">
						<img src="../content/images/2019/05/Screenshot-2019-05-11-at-10.58.30.png" alt="Max Kazakov" />
					</figure>
					<div class="post-author-bio">
						<h4 class="post-author-name"><a href="../author/max/index.html">Max Kazakov</a></h4>
					</div>
					<div class="clear"></div>
				</aside>

			</section>


			<section class="post-comments">
				<a id="show-disqus" class="post-comments-activate">Show Comments</a>
				<div id="disqus_thread"></div>
			</section>


			<aside class="post-nav">
				<a class="post-nav-prev" href="../autoresizing-layout/index.html">
					<section class="post-nav-teaser">
						<i class="ic ic-arrow-right"></i>
						<h2 class="post-nav-title">Autoresizing Layout</h2>
						<p class="post-nav-excerpt">На мой взгляд, инструменты верстки UI в iOS далеко не идеальны и&hellip;</p>
					</section>
				</a>
				<div class="clear"></div>
			</aside>


		</div>
	</article>
</main>

<div id="disqus_thread"></div>
<script>

	/**
	*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
	*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

	var disqus_config = function () {
		this.page.url = "https://maxkazakov.github.io";  // Replace PAGE_URL with your page's canonical URL variable
		this.page.identifier = "ghost-5cd5d398806356e203eb810f"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	};

	(function () { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = 'https://maxkazakov-iosblog.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>


		<div id="body-class" style="display: none;" class="post-template"></div>

		<footer id="footer">
			<div class="inner">
				<section class="credits">
					<span class="credits-theme">Theme <a href="https://github.com/zutrinken/attila">Attila</a> by <a href="https://zutrinken.com" rel="nofollow">zutrinken</a></span>
					<span class="credits-software">Published with <a href="https://ghost.org">Ghost</a></span>
				</section>
			</div>
		</footer>
	</section>

	<script type="text/javascript" src="../assets/js/script.js?v=172587de66"></script>

	

</body>
</html>
